// ===================================
// WWTRAIL - SCHEMA v2.0 + UserCompetition + Imágenes
// Modelo de 3 niveles: Event → Competition → Edition
// ===================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis(schema: "public"), uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ===================================
// ENUMS
// ===================================

enum Language {
  ES
  EN
  IT
  CA
  FR
  DE
}

enum UserRole {
  ADMIN
  ORGANIZER
  ATHLETE
  VIEWER
}

enum RaceType {
  TRAIL
  ULTRA
  VERTICAL
  SKYRUNNING
  CANICROSS
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum UTMBIndex {
  INDEX_20K
  INDEX_50K
  INDEX_100K
  INDEX_100M
}

enum EditionStatus {
  UPCOMING
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  ONGOING
  FINISHED
  CANCELLED
}

enum RegistrationStatus {
  NOT_OPEN
  OPEN
  FULL
  CLOSED
}

enum ParticipationStatus {
  INTERESTED
  REGISTERED
  CONFIRMED
  COMPLETED
  DNS
  DNF
  DSQ
}

enum TranslationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum PostCategory {
  GENERAL
  TRAINING
  NUTRITION
  GEAR
  DESTINATIONS
  INTERVIEWS
  RACE_REPORTS
  TIPS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PromotionType {
  EXCLUSIVE_CONTENT
  COUPON
}

enum PodiumType {
  GENERAL
  MALE
  FEMALE
  CATEGORY
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
}

// ===================================
// USER & AUTH
// ===================================

model User {
  id          String    @id @default(uuid())
  email       String    @unique @db.VarChar(255)
  username    String    @unique @db.VarChar(50)
  password    String    @db.VarChar(255)
  firstName   String?   @db.VarChar(100)
  lastName    String?   @db.VarChar(100)
  role        UserRole  @default(ATHLETE)
  isActive    Boolean   @default(true)
  avatar      String?   @db.Text
  bio         String?   @db.Text
  phone       String?   @db.VarChar(20)
  city        String?   @db.VarChar(100)
  country     String?   @db.VarChar(2)
  language    Language  @default(ES)
  lastLoginAt DateTime?

  // Nuevos campos de perfil
  gender      Gender?
  birthDate   DateTime?
  isPublic    Boolean   @default(false)
  isInsider   Boolean   @default(false) // WWTrail Insider - corresponsal especial

  // Redes sociales
  instagramUrl String?  @db.Text
  facebookUrl  String?  @db.Text
  twitterUrl   String?  @db.Text
  youtubeUrl   String?  @db.Text

  // Omniwallet / Zancadas
  omniwalletCustomerId  String?   // Email/ID en Omniwallet
  zancadasBalance       Int       @default(0)
  omniwalletSyncedAt    DateTime?
  omniwalletCardNumber  String?   @db.VarChar(100)

  // Relaciones
  refreshTokens          RefreshToken[]
  createdEvents          Event[]           @relation("EventCreator")
  createdOrganizers      Organizer[]       @relation("OrganizerCreator")
  createdSpecialSeries   SpecialSeries[]   @relation("SpecialSeriesCreator")
  organizedCompetitions  Competition[]     @relation("CompetitionOrganizer")
  organizedServices      Service[]         @relation("ServiceOrganizer")
  reviews                Review[]
  favorites              Favorite[]
  uploadedFiles          File[]            @relation("FileUploader")
  notifications          Notification[]
  participants           Participant[]
  userEditions           UserEdition[]
  userCompetitions       UserCompetition[]
  blogPosts              Post[]
  promotions             Promotion[]       @relation("PromotionCreator")
  landings               Landing[]         @relation("LandingCreator")
  ratings                EditionRating[]   @relation("UserRatings")
  zancadasTransactions   ZancadasTransaction[] @relation("UserZancadasTransactions")
  managedEvents          EventManager[]    @relation("EventManagerUser")
  assignedManagers       EventManager[]    @relation("EventManagerAssigner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isInsider])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ===================================
// ORGANIZER (Entidad Organizadora)
// ===================================

model Organizer {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text

  // Ubicación
  country String @db.VarChar(2)

  // Información de contacto
  website String? @db.Text

  // Redes sociales
  instagramUrl String? @db.Text
  facebookUrl  String? @db.Text
  twitterUrl   String? @db.Text
  youtubeUrl   String? @db.Text

  // Imágenes
  logoUrl String? @db.Text

  // Estado (DRAFT hasta que admin apruebe)
  status EventStatus @default(DRAFT)

  // Usuario que creó este organizador
  createdById String
  createdBy   User   @relation("OrganizerCreator", fields: [createdById], references: [id])

  // Relaciones
  events Event[] @relation("OrganizerEvents")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([createdById])
  @@map("organizers")
}

// ===================================
// EVENT SYSTEM (3 niveles)
// ===================================

// Nivel 1: EVENT (Entidad permanente)
model Event {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text
  language    Language @default(ES)

  // Ubicación
  country  String                                @db.VarChar(2)
  city     String                                @db.VarChar(100)
  location Unsupported("geometry(Point, 4326)")?

  // Información del evento
  website String? @db.Text
  email   String? @db.VarChar(255)
  phone   String? @db.VarChar(20)

  // Redes sociales
  instagramUrl String? @db.Text
  facebookUrl  String? @db.Text
  twitterUrl   String? @db.Text
  youtubeUrl   String? @db.Text

  // Imágenes
  logo          String?  @db.Text
  coverImage    String?  @db.Text
  gallery       String[] // ✅ Ya existe
  logoUrl       String? // ✅ Agregado por ti
  coverImageUrl String?

  // Meta
  userId String // Usuario que creó el evento
  user   User   @relation("EventCreator", fields: [userId], references: [id])

  // Entidad organizadora (opcional)
  organizerId String?
  organizer   Organizer? @relation("OrganizerEvents", fields: [organizerId], references: [id], onDelete: SetNull)

  status EventStatus @default(DRAFT)

  // Temporalidad
  typicalMonth     Int? // 1-12 para ordenar/filtrar
  firstEditionYear Int // Año de primera edición

  // ✅ NUEVOS CAMPOS - FASE 1
  competitionTypeId String?
  competitionType   CompetitionType? @relation(fields: [competitionTypeId], references: [id], onDelete: SetNull)

  terrainTypeId String?
  terrainType   TerrainType? @relation(fields: [terrainTypeId], references: [id], onDelete: SetNull)

  itraPoints Int?
  utmbPoints Int?

  // Relaciones
  competitions Competition[]
  translations EventTranslation[]
  posts        Post[]           @relation("PostEvent")
  managers     EventManager[]   @relation("EventManagers")

  viewCount Int     @default(0)
  featured  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([country])
  @@index([city])
  @@index([status])
  @@index([userId])
  @@index([organizerId])
  @@index([typicalMonth])
  @@index([competitionTypeId])
  @@index([terrainTypeId])
  @@map("events")
}

// ===================================
// EVENT MANAGERS (Gestores de Eventos)
// Permite asignar usuarios organizadores a eventos
// ===================================

model EventManager {
  id           String   @id @default(uuid())
  eventId      String
  userId       String
  assignedById String

  // Relaciones
  event      Event @relation("EventManagers", fields: [eventId], references: [id], onDelete: Cascade)
  user       User  @relation("EventManagerUser", fields: [userId], references: [id], onDelete: Cascade)
  assignedBy User  @relation("EventManagerAssigner", fields: [assignedById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([assignedById])
  @@map("event_managers")
}

// Nivel 2: COMPETITION (Distancia/carrera específica dentro del evento)
model Competition {
  id          String  @id @default(uuid())
  eventId     String
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text
  language    Language @default(ES)

  // Datos base (pueden ser sobrescritos en Edition)
  baseDistance        Float? // km
  baseElevation       Int? // m+
  baseMaxParticipants Int?

  // Tipo
  type RaceType @default(TRAIL)

  // ✅ IMÁGENES - AGREGADO
  logoUrl    String?  @db.Text // Logo específico de la competición
  coverImage String?  @db.Text // Imagen de cabecera/hero
  gallery    String[] // Array de URLs para galería

  // ✅ CLASIFICACIÓN Y SERIES
  terrainTypeId String?
  terrainType   TerrainType? @relation(fields: [terrainTypeId], references: [id], onDelete: SetNull)

  // Many-to-many: Una competición puede pertenecer a múltiples special series
  specialSeries SpecialSeries[] @relation("CompetitionSpecialSeries")

  itraPoints Int? // Puntos ITRA (0-6)
  utmbIndex  UTMBIndex? // Índice UTMB

  // Meta
  organizerId String
  organizer   User        @relation("CompetitionOrganizer", fields: [organizerId], references: [id])
  status      EventStatus @default(DRAFT)

  // Relaciones
  event            Event                    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  editions         Edition[]
  categories       Category[]
  participants     Participant[]
  results          Result[]
  translations     CompetitionTranslation[]
  reviews          Review[]
  favorites        Favorite[]
  userCompetitions UserCompetition[]
  posts            Post[]                   @relation("PostCompetition")

  viewCount Int     @default(0)
  featured  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([status])
  @@index([type])
  @@index([organizerId])
  @@index([terrainTypeId])
  @@map("competitions")
}

// Nivel 3: EDITION (Edición anual específica)
model Edition {
  id            String @id @default(uuid())
  competitionId String
  year          Int
  slug          String @unique @db.VarChar(255)

  // Datos específicos (null = hereda de Competition)
  distance        Float? // km (null = usa baseDistance)
  elevation       Int? // m+ (null = usa baseElevation)
  maxParticipants Int? // null = usa baseMaxParticipants

  // Ubicación específica (null = hereda de Event)
  city     String?                               @db.VarChar(100)
  location Unsupported("geometry(Point, 4326)")?

  // Idioma del contenido
  language Language @default(ES)

  // Fechas y registro
  startDate             DateTime
  endDate               DateTime?
  registrationOpenDate  DateTime?
  registrationCloseDate DateTime?
  registrationUrl       String?   @db.Text
  resultsUrl            String?   @db.Text // URL de resultados

  // Precios
  prices Json? // { "early": 45, "normal": 60, "late": 75 }

  // ✅ IMÁGENES - AGREGADO
  coverImage String?  @db.Text // Imagen específica de esta edición
  gallery    String[] // Galería de fotos de la edición

  // Estado
  status             EditionStatus      @default(UPCOMING)
  registrationStatus RegistrationStatus @default(NOT_OPEN)

  // Contador de inscritos actual
  currentParticipants Int @default(0)

  // Información adicional
  regulations String? @db.Text
  notes       String? @db.Text

  // ✅ NUEVOS CAMPOS - FASE 1: Ratings
  avgRating    Float? // Promedio de los 7 criterios
  totalRatings Int    @default(0)

  // ✅ NUEVOS CAMPOS - FASE 2: Podios + Crónica
  chronicle String? @db.Text

  // ✅ NUEVOS CAMPOS - FASE 4: Meteo Automático
  weather        Json? // Datos climáticos históricos
  weatherFetched Boolean @default(false)

  // Relaciones
  competition  Competition     @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  userEditions UserEdition[]
  blogPosts    Post[]
  ratings      EditionRating[] @relation("EditionRatings")
  podiums      EditionPodium[] @relation("EditionPodiums")
  photos       EditionPhoto[]  @relation("EditionPhotos")

  viewCount Int     @default(0)
  featured  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([competitionId, year])
  @@index([competitionId])
  @@index([year])
  @@index([status])
  @@index([startDate])
  @@index([avgRating])
  @@map("editions")
}

// ===================================
// USER COMPETITION (Sistema de Seguimiento Personal)
// ===================================

model UserCompetition {
  id            String              @id @default(uuid())
  userId        String
  competitionId String
  status        ParticipationStatus @default(INTERESTED)

  // Resultados opcionales (solo si completó la carrera)
  finishTime        String? // Formato: "02:45:30"
  finishTimeSeconds Int? // Para ordenar
  position          Int? // Posición general
  categoryPosition  Int? // Posición en su categoría
  notes             String?   @db.Text
  personalRating    Int?      @db.SmallInt // 1-5 estrellas
  completedAt       DateTime?

  // Tracking
  markedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([userId, competitionId]) // Un usuario no puede marcar 2 veces la misma competición
  @@index([userId])
  @@index([competitionId])
  @@index([status])
  @@map("user_competitions")
}

// ===================================
// USER EDITION (Participación en edición específica)
// ===================================

model UserEdition {
  id        String              @id @default(uuid())
  userId    String
  editionId String
  status    ParticipationStatus @default(INTERESTED)

  // Resultados (si completó)
  finishTime        String?
  finishTimeSeconds Int?
  position          Int?
  categoryPosition  Int?
  bibNumber         String? @db.VarChar(20)

  // Categoría de participación (como en podios)
  categoryType PodiumType? // GENERAL, MALE, FEMALE, CATEGORY
  categoryName String?     @db.VarChar(100) // Nombre si categoryType=CATEGORY

  // Notas personales
  notes          String?   @db.Text
  personalRating Int?      @db.SmallInt
  completedAt    DateTime?

  // Tracking
  markedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@unique([userId, editionId])
  @@index([userId])
  @@index([editionId])
  @@index([status])
  @@map("user_editions")
}

// ===================================
// TRADUCCIONES
// ===================================

model CompetitionTranslation {
  id            String            @id @default(uuid())
  competitionId String
  competition   Competition       @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  language      Language
  name          String            @db.VarChar(255)
  description   String?           @db.Text
  status        TranslationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([competitionId, language])
  @@index([competitionId])
  @@map("competition_translations")
}

model EventTranslation {
  id          String            @id @default(uuid())
  eventId     String
  event       Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  language    Language
  name        String            @db.VarChar(255)
  description String?           @db.Text
  status      TranslationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, language])
  @@index([eventId])
  @@map("event_translations")
}

model ServiceTranslation {
  id          String            @id @default(uuid())
  serviceId   String
  service     Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  language    Language
  name        String            @db.VarChar(255)
  description String?           @db.Text
  status      TranslationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceId, language])
  @@index([serviceId])
  @@map("service_translations")
}

model SpecialSeriesTranslation {
  id              String            @id @default(uuid())
  specialSeriesId String
  specialSeries   SpecialSeries     @relation(fields: [specialSeriesId], references: [id], onDelete: Cascade)
  language        Language
  name            String            @db.VarChar(255)
  description     String?           @db.Text
  status          TranslationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([specialSeriesId, language])
  @@index([specialSeriesId])
  @@map("special_series_translations")
}

// ===================================
// CATEGORÍAS Y RESULTADOS
// ===================================

model Category {
  id            String      @id @default(uuid())
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  name          String      @db.VarChar(100)
  description   String?     @db.Text
  minAge        Int?
  maxAge        Int?
  gender        String?     @db.VarChar(1)

  participants Participant[]
  results      Result[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([competitionId])
  @@map("categories")
}

model Participant {
  id            String      @id @default(uuid())
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  categoryId    String?
  category      Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  bibNumber String  @db.VarChar(20)
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  email     String? @db.VarChar(255)
  phone     String? @db.VarChar(20)
  country   String? @db.VarChar(2)
  city      String? @db.VarChar(100)
  club      String? @db.VarChar(255)

  emergencyContact String? @db.Text
  medicalInfo      String? @db.Text

  registeredAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  result Result?

  @@index([competitionId])
  @@index([userId])
  @@index([categoryId])
  @@map("participants")
}

model Result {
  id            String      @id @default(uuid())
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  participantId String      @unique
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  categoryId    String?
  category      Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  position          Int
  categoryPosition  Int?
  bibNumber         String @db.VarChar(20)
  finishTime        String @db.VarChar(20)
  finishTimeSeconds Int

  splits Json?

  status String @default("COMPLETED") @db.VarChar(20)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([competitionId])
  @@index([categoryId])
  @@index([position])
  @@map("results")
}

// ===================================
// REVIEWS Y FAVORITOS
// ===================================

model Review {
  id            String      @id @default(uuid())
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating  Int     @db.SmallInt
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@map("reviews")
}

model Favorite {
  id            String      @id @default(uuid())
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@map("favorites")
}

// ===================================
// FILES Y NOTIFICACIONES
// ===================================

model File {
  id           String @id @default(uuid())
  filename     String @db.VarChar(255)
  originalName String @db.VarChar(255)
  mimeType     String @db.VarChar(100)
  size         Int
  path         String @db.Text
  url          String @db.Text

  uploaderId String
  uploader   User   @relation("FileUploader", fields: [uploaderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([uploaderId])
  @@map("files")
}

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    String @db.VarChar(50)
  title   String @db.VarChar(255)
  message String @db.Text
  data    Json?

  read   Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

// ===================================
// BLOG POSTS
// ===================================

model Post {
  id            String  @id @default(uuid())
  slug          String  @unique @db.VarChar(255)
  title         String  @db.VarChar(255)
  excerpt       String? @db.Text
  content       String  @db.Text
  featuredImage String? @db.Text

  category PostCategory @default(GENERAL)
  status   PostStatus   @default(DRAFT)
  language Language     @default(ES)

  // Relaciones opcionales con Event, Competition o Edition
  eventId String?
  event   Event? @relation("PostEvent", fields: [eventId], references: [id], onDelete: SetNull)

  competitionId String?
  competition   Competition? @relation("PostCompetition", fields: [competitionId], references: [id], onDelete: SetNull)

  editionId String?
  edition   Edition? @relation(fields: [editionId], references: [id], onDelete: SetNull)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  viewCount          Int       @default(0)
  publishedAt        DateTime?
  scheduledPublishAt DateTime?

  tags         PostTag[]
  translations PostTranslation[]
  images       PostImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([authorId])
  @@index([eventId])
  @@index([competitionId])
  @@index([editionId])
  @@map("posts")
}

model PostTranslation {
  id       String            @id @default(uuid())
  postId   String
  post     Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  language Language
  title    String            @db.VarChar(255)
  excerpt  String?           @db.Text
  content  String            @db.Text
  status   TranslationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([postId, language])
  @@index([postId])
  @@map("post_translations")
}

model PostTag {
  id    String @id @default(uuid())
  name  String @unique @db.VarChar(50)
  slug  String @unique @db.VarChar(50)
  posts Post[]

  @@map("post_tags")
}

model PostImage {
  id        String  @id @default(uuid())
  postId    String
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  imageUrl  String  @db.Text
  caption   String? @db.Text
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([sortOrder])
  @@map("post_images")
}

// ===================================
// CATÁLOGOS - FASE 1
// ===================================

model CompetitionType {
  id          String  @id @default(uuid())
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("competition_types")
}

model TerrainType {
  id          String  @id @default(uuid())
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  events       Event[]
  competitions Competition[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("terrain_types")
}

model SpecialSeries {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text
  language    Language @default(ES)

  // Ubicación
  country String @db.VarChar(2)

  // Información de contacto
  website String? @db.Text

  // Redes sociales
  instagramUrl String? @db.Text
  facebookUrl  String? @db.Text
  twitterUrl   String? @db.Text
  youtubeUrl   String? @db.Text

  // Imágenes
  logoUrl String? @db.Text

  // Estado (DRAFT hasta que admin apruebe)
  status EventStatus @default(DRAFT)

  // Usuario que creó esta special series
  createdById String
  createdBy   User   @relation("SpecialSeriesCreator", fields: [createdById], references: [id])

  // Relaciones - Many-to-many con Competition
  competitions Competition[] @relation("CompetitionSpecialSeries")
  translations SpecialSeriesTranslation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([createdById])
  @@map("special_series")
}

// ===================================
// EDITION RATINGS - FASE 1
// ===================================

model EditionRating {
  id String @id @default(uuid())

  editionId String
  edition   Edition @relation("EditionRatings", fields: [editionId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("UserRatings", fields: [userId], references: [id], onDelete: Cascade)

  // 7 Criterios (1-4 estrellas cada uno)
  ratingInfoBriefing Int @db.SmallInt // 1-4
  ratingRacePack     Int @db.SmallInt // 1-4
  ratingVillage      Int @db.SmallInt // 1-4
  ratingMarking      Int @db.SmallInt // 1-4
  ratingAid          Int @db.SmallInt // 1-4
  ratingFinisher     Int @db.SmallInt // 1-4
  ratingEco          Int @db.SmallInt // 1-4

  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([editionId, userId])
  @@index([editionId])
  @@index([userId])
  @@map("edition_ratings")
}

// ===================================
// EDITION PODIUMS - FASE 2
// ===================================

model EditionPodium {
  id String @id @default(uuid())

  editionId String
  edition   Edition @relation("EditionPodiums", fields: [editionId], references: [id], onDelete: Cascade)

  type         PodiumType
  categoryName String?    @db.VarChar(100)

  firstPlace String  @db.VarChar(200)
  firstTime  String? @db.VarChar(20)

  secondPlace String? @db.VarChar(200)
  secondTime  String? @db.VarChar(20)

  thirdPlace String? @db.VarChar(200)
  thirdTime  String? @db.VarChar(20)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([editionId])
  @@index([type])
  @@map("edition_podiums")
}

// ===================================
// EDITION PHOTOS - FASE 3
// ===================================

model EditionPhoto {
  id String @id @default(uuid())

  editionId String
  edition   Edition @relation("EditionPhotos", fields: [editionId], references: [id], onDelete: Cascade)

  url          String  @db.Text
  thumbnail    String? @db.Text
  caption      String? @db.Text
  photographer String? @db.VarChar(200)

  width    Int?
  height   Int?
  fileSize Int?
  mimeType String? @db.VarChar(50)

  sortOrder  Int     @default(0)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([editionId])
  @@index([isFeatured])
  @@map("edition_photos")
}

// ===================================
// HOME CONFIGURATION - CMS Home Page
// ===================================

enum HomeBlockType {
  EVENTS
  COMPETITIONS
  EDITIONS
  SERVICES
  POSTS
  TEXT
  LINKS
  MAP
}

enum HomeBlockViewType {
  LIST
  CARDS
}

enum HomeTextSize {
  SM
  MD
  LG
  XL
}

enum HomeTextVariant {
  PARAGRAPH
  HEADING
}

enum EmailTemplateType {
  COUPON_REDEMPTION
  WELCOME
  PASSWORD_RESET
  EVENT_REMINDER
  COMPETITION_UPDATE
}

model HomeConfiguration {
  id           String  @id @default(uuid())
  heroImage    String? @db.Text // URL de la imagen del hero (legacy, usar heroImages)
  heroImages   Json?   // Array de URLs de imágenes para el slider ["url1", "url2", ...]
  heroTitle    String? @db.Text // Título principal del hero
  heroSubtitle String? @db.Text // Subtítulo del hero
  isActive     Boolean @default(true) // Solo una configuración activa a la vez

  blocks HomeBlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("home_configurations")
}

model HomeBlock {
  id              String            @id @default(uuid())
  configurationId String
  configuration   HomeConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  type    HomeBlockType
  order   Int           @default(0) // Orden de aparición
  visible Boolean       @default(true)

  // Configuración específica por tipo (JSON)
  config Json? // Almacena configuración específica por tipo de bloque

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configurationId])
  @@index([order])
  @@map("home_blocks")
}

// CATEGORÍAS DE SERVICIOS
model ServiceCategory {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(100)
  slug String @unique @db.VarChar(100)
  icon String @db.VarChar(10) // Emoji para mostrar en mapas y UI

  // Relaciones
  services   Service[]
  promotions Promotion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([name])
  @@map("service_categories")
}

// SERVICIOS (Alojamientos, Restaurantes, Tiendas, Puntos de Información, etc.)
model Service {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text
  language    Language @default(ES)

  // Categoría (relación con ServiceCategory)
  categoryId String?
  category   ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Ubicación
  country  String                                @db.VarChar(2)
  city     String                                @db.VarChar(100)
  location Unsupported("geometry(Point, 4326)")?

  // Información de contacto
  website String? @db.Text

  // Imágenes
  logoUrl    String?  @db.Text
  coverImage String?  @db.Text
  gallery    String[] // Array de URLs para galería de fotos

  // Meta
  organizerId String
  organizer   User        @relation("ServiceOrganizer", fields: [organizerId], references: [id])
  status      EventStatus @default(DRAFT) // Reutilizamos EventStatus (DRAFT, PUBLISHED, CANCELLED)

  // Relaciones
  translations ServiceTranslation[]

  viewCount Int     @default(0)
  featured  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([country])
  @@index([city])
  @@index([categoryId])
  @@index([status])
  @@index([organizerId])
  @@index([featured])
  @@map("services")
}

// ===================================
// PROMOTIONS & COUPONS
// ===================================

model Promotion {
  id   String        @id @default(uuid())
  type PromotionType // EXCLUSIVE_CONTENT o COUPON

  // Campos comunes
  title       String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String   @db.Text
  coverImage  String?  @db.Text
  gallery     String[] // Array de URLs para galería de fotos
  brandUrl    String?  @db.Text // URL de la marca/fabricante

  // Categoría (usa las mismas que servicios)
  categoryId String?
  category   ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Idioma
  language Language @default(ES)

  // Traducciones
  translations PromotionTranslation[]

  // Países (relación many-to-many o GLOBAL si no tiene países asociados)
  countries PromotionCountry[]
  isGlobal  Boolean            @default(false)

  // Campos específicos por tipo
  exclusiveContent String? @db.Text // Solo para EXCLUSIVE_CONTENT (contenido oculto)

  // Para cupones: pool de códigos
  couponCodes CouponCode[]
  redemptions CouponRedemption[]

  // Estado y metadatos
  status    PostStatus @default(DRAFT) // Reutilizamos PostStatus
  viewCount Int        @default(0)
  featured  Boolean    @default(false)

  // Usuario creador
  createdById String
  createdBy   User   @relation("PromotionCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([type])
  @@index([status])
  @@index([language])
  @@index([categoryId])
  @@index([createdById])
  @@index([isGlobal])
  @@map("promotions")
}

// Traducciones de promociones
model PromotionTranslation {
  id          String    @id @default(uuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  language    Language
  title       String    @db.VarChar(255)
  description String    @db.Text

  // Contenido exclusivo traducido (si aplica)
  exclusiveContent String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([promotionId, language])
  @@index([promotionId])
  @@index([language])
  @@map("promotion_translations")
}

// Relación many-to-many para países
model PromotionCountry {
  id          String    @id @default(uuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  countryCode String    @db.VarChar(2) // ISO 3166-1 alpha-2

  createdAt DateTime @default(now())

  @@unique([promotionId, countryCode])
  @@index([promotionId])
  @@index([countryCode])
  @@map("promotion_countries")
}

// Pool de códigos de cupón
model CouponCode {
  id          String    @id @default(uuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  code   String    @db.VarChar(100) // Código único del cupón
  isUsed Boolean   @default(false)
  usedAt DateTime?
  usedBy String?   @db.VarChar(255) // Email del usuario que lo canjeó

  redemption CouponRedemption?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([promotionId, code])
  @@index([promotionId])
  @@index([isUsed])
  @@map("coupon_codes")
}

// Registro de canjes de cupones
model CouponRedemption {
  id           String     @id @default(uuid())
  promotionId  String
  promotion    Promotion  @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  couponCodeId String     @unique
  couponCode   CouponCode @relation(fields: [couponCodeId], references: [id], onDelete: Cascade)

  userName  String @db.VarChar(255)
  userEmail String @db.VarChar(255)

  emailSent   Boolean   @default(false)
  emailSentAt DateTime?

  createdAt DateTime @default(now())

  @@index([promotionId])
  @@index([userEmail])
  @@map("coupon_redemptions")
}

// ===================================
// EMAIL TEMPLATES
// ===================================

// Plantillas de email configurables
model EmailTemplate {
  id   String            @id @default(uuid())
  type EmailTemplateType @unique // Tipo de email (solo una plantilla activa por tipo)
  name String            @db.VarChar(100) // Nombre descriptivo

  subject  String @db.VarChar(255) // Asunto del email
  htmlBody String @db.Text // Cuerpo HTML con variables {{variable}}
  textBody String @db.Text // Versión texto plano (opcional pero recomendado)

  // Variables disponibles para este tipo de template (JSON)
  // Ejemplo: {"userName": "Nombre del usuario", "couponCode": "Código del cupón"}
  availableVariables Json @default("{}")

  isActive Boolean @default(true) // Si está activa o no

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

// ===================================
// SEO MANAGEMENT SYSTEM
// ===================================

// Configuración global de SEO (templates y prompts por tipo de entidad)
model SEOConfig {
  id                      String   @id @default(uuid())
  entityType              String   @unique // 'event', 'competition', 'edition', 'post', 'service', 'specialSeries', 'home', 'event-list', etc.
  
  // Templates con variables tipo {name}, {location}, {date}, etc.
  metaTitleTemplate       String?  @db.Text
  metaDescriptionTemplate String?  @db.Text
  
  // Prompt personalizable para generar Q&A con IA
  qaPrompt                String?  @db.Text
  
  // Variables disponibles para este tipo de entidad (JSON array)
  // Ejemplo: ["name", "location", "distance", "date", "year"]
  availableVariables      Json?    @default("[]")
  
  // Configuración de auto-generación
  autoGenerate            Boolean  @default(true)  // Si debe auto-generar SEO
  generateOnCreate        Boolean  @default(true)  // Generar al crear entidad
  generateOnUpdate        Boolean  @default(false) // Regenerar al actualizar entidad
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@index([entityType])
  @@map("seo_config")
}

// SEO específico de cada entidad o página estática
model SEO {
  id              String   @id @default(uuid())
  entityType      String   // 'event', 'competition', 'edition', 'post', 'service', 'specialSeries', 'page'
  entityId        String?  // ID de la entidad (null para páginas estáticas)
  slug            String?  // Slug para páginas estáticas: 'home', 'events-list', 'competitions-list', etc.
  language        Language @default(ES) // Idioma del contenido SEO

  // Contenido SEO
  metaTitle       String?  @db.VarChar(255)
  metaDescription String?  @db.Text

  // FAQ optimizado para LLMs - Array de {question: string, answer: string}
  llmFaq          Json?    @default("[]")

  // Metadata
  autoGenerated   Boolean  @default(false) // Si fue generado automáticamente
  lastRegenerated DateTime? // Última vez que se regeneró
  translationStatus TranslationStatus @default(PENDING) // Estado de traducción

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([entityType, entityId, language])
  @@unique([entityType, slug, language])
  @@index([entityType, entityId, language])
  @@index([entityType, slug, language])
  @@map("seo_metadata")
}

// ===================================
// INSIDER CONFIG - Configuración de WWTrail Insiders
// ===================================
model InsiderConfig {
  id          String  @id @default(uuid())

  // Badge que se muestra sobre la foto de los insiders
  badgeUrl    String? @db.Text

  // Texto introductorio por idioma (aparece en la página de listado de Insiders)
  introTextES String? @db.Text
  introTextEN String? @db.Text
  introTextIT String? @db.Text
  introTextCA String? @db.Text
  introTextFR String? @db.Text
  introTextDE String? @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("insider_config")
}

// ==========================================
// FOOTER - Global site footer
// ==========================================
model Footer {
  id String @id @default(uuid())

  // Columna izquierda por idioma (HTML)
  leftColumnES String? @db.Text
  leftColumnEN String? @db.Text
  leftColumnIT String? @db.Text
  leftColumnCA String? @db.Text
  leftColumnFR String? @db.Text
  leftColumnDE String? @db.Text

  // Columna central por idioma (HTML)
  centerColumnES String? @db.Text
  centerColumnEN String? @db.Text
  centerColumnIT String? @db.Text
  centerColumnCA String? @db.Text
  centerColumnFR String? @db.Text
  centerColumnDE String? @db.Text

  // Columna derecha por idioma (HTML)
  rightColumnES String? @db.Text
  rightColumnEN String? @db.Text
  rightColumnIT String? @db.Text
  rightColumnCA String? @db.Text
  rightColumnFR String? @db.Text
  rightColumnDE String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("footer")
}

// ==========================================
// LANDINGS - Custom landing pages
// ==========================================
model Landing {
  id       String   @id @default(uuid())
  title    String   @db.VarChar(255)
  slug     String   @unique @db.VarChar(255)
  language Language @default(ES)

  // Contenido
  coverImage String?  @db.Text
  gallery    String[] // Array de URLs para galería de fotos
  content    String   @db.Text // WYSIWYG content

  // SEO
  metaTitle       String? @db.VarChar(255)
  metaDescription String? @db.Text

  // Traducciones
  translations LandingTranslation[]

  // Usuario creador (solo admins)
  createdById String
  createdBy   User   @relation("LandingCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([language])
  @@index([createdById])
  @@map("landings")
}

model LandingTranslation {
  id        String  @id @default(uuid())
  landingId String
  landing   Landing @relation(fields: [landingId], references: [id], onDelete: Cascade)

  language Language
  title    String   @db.VarChar(255)
  content  String   @db.Text

  // SEO traducido
  metaTitle       String? @db.VarChar(255)
  metaDescription String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([landingId, language])
  @@index([landingId])
  @@index([language])
  @@map("landing_translations")
}

// ===================================
// ZANCADAS - OMNIWALLET INTEGRATION
// Sistema de puntos de fidelización
// ===================================

// Configuración global de conexión con Omniwallet
model ZancadasConfig {
  id String @id @default(uuid())

  // Conexión Omniwallet
  omniwalletSubdomain     String? @db.VarChar(100)
  omniwalletApiToken      String? @db.Text // Encriptado
  omniwalletWebhookSecret String? @db.Text // Encriptado
  isEnabled               Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("zancadas_config")
}

// Acciones configurables que otorgan Zancadas
model ZancadasAction {
  id          String  @id @default(uuid())
  actionCode  String  @unique @db.VarChar(50) // 'REGISTER', 'LOGIN', 'RATING', 'PARTICIPATION'
  actionName  String  @db.VarChar(100) // Nombre para mostrar
  description String? @db.Text
  points      Int     @default(0)
  isEnabled   Boolean @default(true)
  maxPerDay   Int? // Límite diario (null = sin límite)
  maxPerUser  Int? // Límite total por usuario (null = sin límite)

  // Para acciones de participación: estados que activan puntos
  // JSON array de ParticipationStatus: ["COMPLETED", "REGISTERED", etc.]
  triggerStatuses Json? @default("[]")

  // Relaciones
  transactions ZancadasTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([actionCode])
  @@index([isEnabled])
  @@map("zancadas_actions")
}

// Registro de transacciones de Zancadas
model ZancadasTransaction {
  id       String @id @default(uuid())
  userId   String
  actionId String
  points   Int

  // Referencia al objeto relacionado (edición, rating, etc.)
  referenceType String? @db.VarChar(50) // 'EDITION', 'RATING', 'LOGIN', etc.
  referenceId   String?

  // Sincronización con Omniwallet
  omniwalletSynced     Boolean @default(false)
  omniwalletExternalId String? @unique @db.VarChar(255)
  omniwalletError      String? @db.Text

  // Relaciones
  user   User          @relation("UserZancadasTransactions", fields: [userId], references: [id], onDelete: Cascade)
  action ZancadasAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([actionId])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([omniwalletSynced])
  @@map("zancadas_transactions")
}

// Registro de webhooks recibidos (para idempotencia)
model ZancadasWebhook {
  id      String @id @default(uuid())
  hookId  String @unique @db.VarChar(255) // X-Omniwallet-Hook-Id
  event   String @db.VarChar(100)
  payload Json

  processedAt DateTime @default(now())

  @@index([hookId])
  @@map("zancadas_webhooks")
}
