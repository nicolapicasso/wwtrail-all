// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  ORGANIZER
  ATHLETE
  VIEWER
}

enum Language {
  ES
  EN
  IT
  CA
  FR
  DE
}

enum CompetitionType {
  TRAIL
  ULTRA
  VERTICAL
  SKYRUNNING
  CANICROSS
  OTHER
}

enum CompetitionStatus {
  DRAFT
  PUBLISHED
  ONGOING
  FINISHED
  CANCELLED
}

enum RegistrationStatus {
  OPEN
  CLOSED
  FULL
  COMING_SOON
}

enum ParticipantStatus {
  REGISTERED
  CONFIRMED
  DNS // Did Not Start
  DNF // Did Not Finish
  DSQ // Disqualified
  FINISHED
}

enum TranslationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum FileType {
  IMAGE
  DOCUMENT
  GPX
  KML
  VIDEO
  OTHER
}

// ============================================
// USUARIOS Y AUTENTICACIÓN
// ============================================
enum UserCompetitionStatus {
  INTERESTED      // "Me interesa"
  REGISTERED      // "Me he inscrito" (externamente)
  CONFIRMED       // "Inscripción confirmada"
  COMPLETED       // "He completado la carrera"
  DNF             // "No terminé" (Did Not Finish)
  DNS             // "No participé" (Did Not Start)
}


model User {
  userCompetitions  UserCompetition[]
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  username  String   @unique
  password  String // Hash bcrypt
  firstName String?
  lastName  String?
  
  role      UserRole @default(ATHLETE)
  language  Language @default(ES)
  
  avatar    String?
  bio       String?
  phone     String?
  birthDate DateTime?
  
  // Ubicación del usuario
  country   String?
  city      String?
  
  isActive  Boolean  @default(true)
  isVerified Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relaciones
  competitions    Competition[]
  participants    Participant[]
  results         Result[]
  reviews         Review[]
  favorites       Favorite[]
  notifications   Notification[]
  refreshTokens   RefreshToken[]
  
  @@index([email])
  @@index([username])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// COMPETICIONES
// ============================================

model Competition {
  userCompetitions  UserCompetition[]
  id          String  @id @default(uuid()) @db.Uuid
  slug        String  @unique
  
  // Información básica (idioma base ES)
  name        String
  description String? @db.Text
  
  // Tipo y estado
  type        CompetitionType
  status      CompetitionStatus @default(DRAFT)
  
  // Fechas
  startDate   DateTime
  endDate     DateTime?
  
  // Registro
  registrationStatus RegistrationStatus @default(COMING_SOON)
  registrationUrl    String?
  registrationStart  DateTime?
  registrationEnd    DateTime?
  maxParticipants    Int?
  currentParticipants Int @default(0)
  
  // Ubicación
  country     String
  region      String?
  city        String
  
  // Coordenadas (Point PostGIS)
  location    Unsupported("geometry(Point, 4326)")?
  
  // Detalles técnicos
  distance    Float? // en km
  elevation   Float? // desnivel positivo en m
  
  // URLs y contacto
  website     String?
  email       String?
  phone       String?
  
  // Imágenes
  coverImage  String?
  logoImage   String?
  
  // Organizador
  organizerId String  @db.Uuid
  organizer   User    @relation(fields: [organizerId], references: [id])
  
  // Metadatos
  isHighlighted Boolean @default(false)
  viewCount     Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  translations  CompetitionTranslation[]
  categories    Category[]
  participants  Participant[]
  results       Result[]
  reviews       Review[]
  files         File[]
  favorites     Favorite[]
  
  @@index([slug])
  @@index([status])
  @@index([startDate])
  @@index([country])
  @@index([type])
  @@index([organizerId])
  @@map("competitions")
}

model CompetitionTranslation {
  id            String  @id @default(uuid()) @db.Uuid
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  language      Language
  name          String
  description   String? @db.Text
  
  // Control de traducción
  status        TranslationStatus @default(PENDING)
  translatedBy  String? // 'AI' o ID del traductor
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([competitionId, language])
  @@index([competitionId])
  @@index([language])
  @@map("competition_translations")
}

// ============================================
// CATEGORÍAS DE COMPETICIÓN
// ============================================

model Category {
  id            String  @id @default(uuid()) @db.Uuid
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  name          String
  distance      Float? // en km
  elevation     Float? // en m
  price         Float?
  currency      String @default("EUR")
  maxParticipants Int?
  
  // Ruta GPX/KML
  routeFile     String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relaciones
  participants  Participant[]
  results       Result[]
  
  @@index([competitionId])
  @@map("categories")
}

// ============================================
// PARTICIPANTES
// ============================================

model Participant {
  id            String  @id @default(uuid()) @db.Uuid
  
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  categoryId    String?  @db.Uuid
  category      Category? @relation(fields: [categoryId], references: [id])
  
  userId        String?  @db.Uuid
  user          User?    @relation(fields: [userId], references: [id])
  
  // Info del participante (por si no es usuario registrado)
  firstName     String?
  lastName      String?
  email         String?
  bibNumber     String?
  
  status        ParticipantStatus @default(REGISTERED)
  
  registeredAt  DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relaciones
  results       Result[]
  
  @@unique([competitionId, bibNumber])
  @@index([competitionId])
  @@index([userId])
  @@index([categoryId])
  @@map("participants")
}

// ============================================
// RESULTADOS
// ============================================

model Result {
  id            String  @id @default(uuid()) @db.Uuid
  
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  categoryId    String  @db.Uuid
  category      Category @relation(fields: [categoryId], references: [id])
  
  participantId String  @db.Uuid
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  
  userId        String? @db.Uuid
  user          User?   @relation(fields: [userId], references: [id])
  
  // Resultados
  position      Int?
  time          String? // Formato: HH:MM:SS
  timeSeconds   Int?
  
  // Datos adicionales
  pace          String? // min/km
  avgHeartRate  Int?
  
  // Verificación
  isVerified    Boolean @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([competitionId, participantId])
  @@index([competitionId])
  @@index([categoryId])
  @@index([participantId])
  @@index([userId])
  @@map("results")
}

// ============================================
// RESEÑAS Y FAVORITOS
// ============================================

model Review {
  id            String  @id @default(uuid()) @db.Uuid
  
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  userId        String  @db.Uuid
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating        Int // 1-5
  comment       String? @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@map("reviews")
}

model Favorite {
  id            String  @id @default(uuid()) @db.Uuid
  
  competitionId String  @db.Uuid
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  userId        String  @db.Uuid
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@map("favorites")
}

// ============================================
// ARCHIVOS
// ============================================

model File {
  id            String  @id @default(uuid()) @db.Uuid
  
  competitionId String? @db.Uuid
  competition   Competition? @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  filename      String
  originalName  String
  path          String
  url           String
  mimeType      String
  size          Int
  type          FileType
  
  createdAt     DateTime @default(now())
  
  @@index([competitionId])
  @@map("files")
}

// ============================================
// NOTIFICACIONES
// ============================================

model Notification {
  id        String  @id @default(uuid()) @db.Uuid
  
  userId    String  @db.Uuid
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String  @db.Text
  type      String // 'info', 'success', 'warning', 'error'
  
  isRead    Boolean @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model UserCompetition {
  id                String                  @id @default(uuid()) @db.Uuid
  userId            String                  @db.Uuid
  competitionId     String                  @db.Uuid

  // Estado
  status            UserCompetitionStatus   @default(INTERESTED)

  // Resultados personales (opcionales)
  finishTime        String?                 // Formato: "HH:MM:SS"
  finishTimeSeconds Int?                    // Para cálculos
  position          Int?                    // Posición general
  categoryPosition  Int?                    // Posición en categoría

  // Notas y valoración personal
  notes             String?                 @db.Text
  personalRating    Int?                    // 1-5 estrellas

  // Fechas
  markedAt          DateTime                @default(now())
  completedAt       DateTime?               // Fecha real de participación
  updatedAt         DateTime                @updatedAt

  // Relaciones
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition       Competition             @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([userId, competitionId])
  @@index([userId])
  @@index([competitionId])
  @@index([status])
  @@map("user_competitions")
}
