// ===================================
// WWTRAIL - NEW SCHEMA v2.0
// Modelo de 3 niveles: Event → Competition → Edition
// ===================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis(schema: "public"), uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ===================================
// ENUMS
// ===================================

enum Language {
  ES
  EN
  IT
  CA
  FR
  DE
}

enum UserRole {
  ADMIN
  ORGANIZER
  ATHLETE
  VIEWER
}

enum RaceType {
  TRAIL
  ULTRA
  VERTICAL
  SKYRUNNING
  CANICROSS
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum EditionStatus {
  UPCOMING
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  ONGOING
  FINISHED
  CANCELLED
}

enum RegistrationStatus {
  NOT_OPEN
  OPEN
  FULL
  CLOSED
}

enum ParticipationStatus {
  INTERESTED
  REGISTERED
  CONFIRMED
  COMPLETED
  DNS
  DNF
  DSQ
}

enum TranslationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum PostCategory {
  GENERAL
  TRAINING
  NUTRITION
  GEAR
  DESTINATIONS
  INTERVIEWS
  RACE_REPORTS
  TIPS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ===================================
// USER & AUTH
// ===================================

model User {
  id          String    @id @default(uuid())
  email       String    @unique @db.VarChar(255)
  username    String    @unique @db.VarChar(50)
  password    String    @db.VarChar(255)
  firstName   String?   @db.VarChar(100)
  lastName    String?   @db.VarChar(100)
  role        UserRole  @default(ATHLETE)
  isActive    Boolean   @default(true)
  avatar      String?   @db.Text
  bio         String?   @db.Text
  phone       String?   @db.VarChar(20)
  city        String?   @db.VarChar(100)
  country     String?   @db.VarChar(2)
  language    Language  @default(ES)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  refreshTokens     RefreshToken[]
  organizedEvents   Event[]              @relation("EventOrganizer")
  userEditions      UserEdition[]
  posts             Post[]
  reviews           Review[]
  participants      Participant[]
  results           Result[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

// ===================================
// NIVEL 1: EVENT (Evento permanente)
// ===================================

model Event {
  id               String    @id @default(uuid())
  slug             String    @unique @db.VarChar(255)
  name             String    @db.VarChar(255)
  description      String?   @db.Text
  
  // Ubicación general
  country          String    @db.VarChar(2)
  city             String    @db.VarChar(100)
  location         Unsupported("geography(Point, 4326)")?
  latitude         Decimal?  @db.Decimal(10, 8)
  longitude        Decimal?  @db.Decimal(11, 8)
  
  // Información general
  websiteUrl       String?   @db.Text
  email            String?   @db.VarChar(255)
  phone            String?   @db.VarChar(20)
  facebookUrl      String?   @db.Text
  instagramUrl     String?   @db.Text
  
  // Media
  logo             String?   @db.Text
  coverImage       String?   @db.Text
  images           String[]
  
  // Metadata
  firstEditionYear Int?
  isActive         Boolean   @default(true)
  isHighlighted    Boolean   @default(false)
  viewCount        Int       @default(0)
  originalLanguage Language  @default(ES)
  
  // Estado
  status           EventStatus @default(DRAFT)
  
  // Relations
  organizerId      String
  organizer        User      @relation("EventOrganizer", fields: [organizerId], references: [id])
  
  competitions     Competition[]
  translations     EventTranslation[]
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([slug])
  @@index([country])
  @@index([status])
  @@index([organizerId])
  @@map("events")
}

model EventTranslation {
  id          String            @id @default(uuid())
  eventId     String
  event       Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  language    Language
  name        String            @db.VarChar(255)
  description String?           @db.Text
  status      TranslationStatus @default(PENDING)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([eventId, language])
  @@index([eventId])
  @@map("event_translations")
}

// ===================================
// NIVEL 2: COMPETITION (Distancia permanente)
// ===================================

model Competition {
  id                  String   @id @default(uuid())
  eventId             String
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  slug                String   @unique @db.VarChar(255)
  name                String   @db.VarChar(255)
  shortName           String?  @db.VarChar(50)
  description         String?  @db.Text
  
  // Tipo
  type                RaceType @default(TRAIL)
  
  // Datos BASE (valores por defecto que heredan las ediciones)
  baseDistance        Decimal? @db.Decimal(6, 2)
  baseElevation       Int?
  baseMaxParticipants Int?
  baseTechnicalLevel  Int?     @db.SmallInt // 1-5
  
  // Información general
  websiteUrl          String?  @db.Text
  
  // Display
  displayOrder        Int      @default(0)
  isActive            Boolean  @default(true)
  
  // Relations
  editions            Edition[]
  translations        CompetitionTranslation[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([eventId, slug])
  @@index([eventId])
  @@index([slug])
  @@map("competitions")
}

model CompetitionTranslation {
  id            String            @id @default(uuid())
  competitionId String
  competition   Competition       @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  language      Language
  name          String            @db.VarChar(255)
  shortName     String?           @db.VarChar(50)
  description   String?           @db.Text
  status        TranslationStatus @default(PENDING)
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([competitionId, language])
  @@index([competitionId])
  @@map("competition_translations")
}

// ===================================
// NIVEL 3: EDITION (Edición anual)
// ===================================

model Edition {
  id                  String             @id @default(uuid())
  competitionId       String
  competition         Competition        @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  year                Int
  slug                String             @unique @db.VarChar(255)
  
  // Datos específicos de esta edición (si NULL, hereda del base)
  distance            Decimal?           @db.Decimal(6, 2)
  elevation           Int?
  technicalLevel      Int?               @db.SmallInt
  
  // Fechas específicas
  startDate           DateTime
  startTime           String?            @db.VarChar(10)
  cutoffTime          String?            @db.VarChar(10)
  
  // Ubicación específica (si cambia respecto al evento)
  city                String?            @db.VarChar(100)
  location            Unsupported("geography(Point, 4326)")?
  latitude            Decimal?           @db.Decimal(10, 8)
  longitude           Decimal?           @db.Decimal(11, 8)
  
  // Recorrido
  gpxFile             String?            @db.Text
  elevationProfile    String?            @db.Text
  routeDescription    String?            @db.Text
  routeMap            String?            @db.Text
  
  // Participación
  maxParticipants     Int?
  currentParticipants Int                @default(0)
  minimumAge          Int?               @default(18)
  
  // Inscripción
  price               Decimal?           @db.Decimal(10, 2)
  currency            String?            @db.VarChar(3) @default("EUR")
  earlyBirdPrice      Decimal?           @db.Decimal(10, 2)
  earlyBirdDeadline   DateTime?
  registrationUrl     String?            @db.Text
  registrationStatus  RegistrationStatus @default(NOT_OPEN)
  
  // Estado
  status              EditionStatus      @default(UPCOMING)
  isCancelled         Boolean            @default(false)
  cancellationReason  String?            @db.Text
  
  // Estadísticas de resultados
  finishers           Int?
  dnfCount            Int?
  dnsCount            Int?
  dsqCount            Int?
  winnerTime          String?            @db.VarChar(20)
  recordTime          String?            @db.VarChar(20)
  recordHolder        String?            @db.VarChar(255)
  averageTime         String?            @db.VarChar(20)
  
  // Media
  featuredImage       String?            @db.Text
  images              String[]
  videoUrl            String?            @db.Text
  
  // Engagement
  viewCount           Int                @default(0)
  
  // Relations
  participants        Participant[]
  results             Result[]
  reviews             Review[]
  userEditions        UserEdition[]
  posts               Post[]
  translations        EditionTranslation[]
  
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@unique([competitionId, year])
  @@index([competitionId])
  @@index([year])
  @@index([startDate])
  @@index([status])
  @@index([slug])
  @@map("editions")
}

model EditionTranslation {
  id                 String            @id @default(uuid())
  editionId          String
  edition            Edition           @relation(fields: [editionId], references: [id], onDelete: Cascade)
  language           Language
  routeDescription   String?           @db.Text
  cancellationReason String?           @db.Text
  status             TranslationStatus @default(PENDING)
  
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@unique([editionId, language])
  @@index([editionId])
  @@map("edition_translations")
}

// ===================================
// USER TRACKING (Participación histórica)
// ===================================

model UserEdition {
  id             String              @id @default(uuid())
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  editionId      String
  edition        Edition             @relation(fields: [editionId], references: [id], onDelete: Cascade)
  
  // Estado de participación
  status         ParticipationStatus @default(INTERESTED)
  
  // Si participó, detalles:
  bibNumber      String?             @db.VarChar(20)
  position       Int?
  categoryName   String?             @db.VarChar(50)
  categoryRank   Int?
  time           String?             @db.VarChar(20)
  pace           String?             @db.VarChar(20)
  
  // Experiencia personal
  notes          String?             @db.Text
  rating         Int?                @db.SmallInt // 1-5
  wouldRepeat    Boolean?
  
  // Media
  photos         String[]
  certificateUrl String?             @db.Text
  
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@unique([userId, editionId])
  @@index([userId])
  @@index([editionId])
  @@map("user_editions")
}

// ===================================
// PARTICIPANTS (Inscripciones oficiales)
// ===================================

model Participant {
  id          String              @id @default(uuid())
  editionId   String
  edition     Edition             @relation(fields: [editionId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  firstName   String?             @db.VarChar(100)
  lastName    String?             @db.VarChar(100)
  email       String?             @db.VarChar(255)
  bibNumber   String?             @db.VarChar(20)
  category    String?             @db.VarChar(50)
  team        String?             @db.VarChar(100)
  
  status      ParticipationStatus @default(REGISTERED)
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([editionId, bibNumber])
  @@index([editionId])
  @@index([userId])
  @@map("participants")
}

// ===================================
// RESULTS (Resultados oficiales)
// ===================================

model Result {
  id          String   @id @default(uuid())
  editionId   String
  edition     Edition  @relation(fields: [editionId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  bibNumber   String?  @db.VarChar(20)
  firstName   String?  @db.VarChar(100)
  lastName    String?  @db.VarChar(100)
  
  position    Int?
  category    String?  @db.VarChar(50)
  categoryRank Int?
  
  time        String?  @db.VarChar(20)
  timeSeconds Int?
  pace        String?  @db.VarChar(20)
  
  // Splits
  checkpoint1 String?  @db.VarChar(20)
  checkpoint2 String?  @db.VarChar(20)
  checkpoint3 String?  @db.VarChar(20)
  checkpoint4 String?  @db.VarChar(20)
  
  status      ParticipationStatus @default(COMPLETED)
  isVerified  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([editionId, bibNumber])
  @@index([editionId])
  @@index([userId])
  @@index([position])
  @@map("results")
}

// ===================================
// REVIEWS
// ===================================

model Review {
  id          String   @id @default(uuid())
  editionId   String
  edition     Edition  @relation(fields: [editionId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating      Int      @db.SmallInt // 1-5
  comment     String?  @db.Text
  
  // Aspectos específicos (opcional)
  organization Int?    @db.SmallInt // 1-5
  route       Int?     @db.SmallInt
  atmosphere  Int?     @db.SmallInt
  valueForMoney Int?   @db.SmallInt
  
  isVerified  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([editionId, userId])
  @@index([editionId])
  @@index([userId])
  @@map("reviews")
}

// ===================================
// BLOG/MAGAZINE
// ===================================

model Post {
  id            String       @id @default(uuid())
  slug          String       @unique @db.VarChar(255)
  title         String       @db.VarChar(255)
  excerpt       String?      @db.Text
  content       String       @db.Text
  featuredImage String?      @db.Text
  
  category      PostCategory @default(GENERAL)
  status        PostStatus   @default(DRAFT)
  
  // Relación con edición específica
  editionId     String?
  edition       Edition?     @relation(fields: [editionId], references: [id], onDelete: SetNull)
  
  authorId      String
  author        User         @relation(fields: [authorId], references: [id])
  
  viewCount     Int          @default(0)
  publishedAt   DateTime?
  
  tags          PostTag[]
  translations  PostTranslation[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([authorId])
  @@index([editionId])
  @@map("posts")
}

model PostTranslation {
  id          String            @id @default(uuid())
  postId      String
  post        Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  language    Language
  title       String            @db.VarChar(255)
  excerpt     String?           @db.Text
  content     String            @db.Text
  status      TranslationStatus @default(PENDING)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([postId, language])
  @@index([postId])
  @@map("post_translations")
}

model PostTag {
  id    String @id @default(uuid())
  name  String @unique @db.VarChar(50)
  slug  String @unique @db.VarChar(50)
  posts Post[]

  @@map("post_tags")
}

// ===================================
// NOTAS IMPORTANTES
// ===================================

// 1. El modelo antiguo "competitions" se deprecará gradualmente
// 2. Las rutas antiguas seguirán funcionando como alias
// 3. La migración de datos será:
//    - Competition antigua → Event + Competition + Edition 2025
// 4. Herencia de datos:
//    - Si Edition.distance es NULL → usa Competition.baseDistance
//    - Si Edition.elevation es NULL → usa Competition.baseElevation
// 5. Auto-creación de ediciones:
//    - Cada 1 de enero se crean automáticamente ediciones nuevas
//    - Se puede crear ediciones históricas on-demand
