# Sistema de SEO con Generaci√≥n AI

## Descripci√≥n General

Sistema completo de gesti√≥n SEO que genera autom√°ticamente metadatos y contenido FAQ optimizado para motores de b√∫squeda y LLMs (ChatGPT, Claude, Perplexity) mediante IA.

## Caracter√≠sticas Principales

### 1. **Metadatos SEO**
- Meta title personalizado por entidad
- Meta description optimizada
- Templates con variables din√°micas (ej: `{name}`, `{location}`, `{distance}`)

### 2. **FAQ Generado por IA**
- 5 preguntas y respuestas generadas autom√°ticamente por GPT-4o-mini
- Optimizado para que LLMs puedan extraer informaci√≥n f√°cilmente
- Schema.org JSON-LD markup para motores de b√∫squeda
- Visualizaci√≥n opcional en las p√°ginas p√∫blicas

### 3. **Configuraci√≥n por Tipo de Entidad**
- Eventos (`event`)
- Competiciones (`competition`)
- Posts/Art√≠culos (`post`)
- P√°ginas est√°ticas (`home`, `events-list`)

### 4. **Generaci√≥n Autom√°tica**
- Se activa al crear eventos, competiciones o posts publicados
- Ejecuci√≥n en segundo plano (no bloquea la creaci√≥n)
- Configurable por tipo de entidad

### 5. **Interfaz de Administraci√≥n**
- Configuraci√≥n de templates y prompts
- Listado y edici√≥n de SEO generado
- Regeneraci√≥n manual de contenido
- Edici√≥n manual de metadatos y FAQ

---

## Arquitectura del Sistema

### Backend

#### Base de Datos (Prisma)

**Modelo `SEOConfig`** - Configuraci√≥n por tipo de entidad:
```prisma
model SEOConfig {
  id                      String   @id @default(uuid())
  entityType              String   @unique
  metaTitleTemplate       String?
  metaDescriptionTemplate String?
  qaPrompt                String?
  availableVariables      Json?
  autoGenerate            Boolean  @default(true)
  generateOnCreate        Boolean  @default(true)
  generateOnUpdate        Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}
```

**Modelo `SEO`** - Metadatos SEO por entidad:
```prisma
model SEO {
  id              String   @id @default(uuid())
  entityType      String
  entityId        String?
  slug            String?
  metaTitle       String?
  metaDescription String?
  llmFaq          Json?    // Array de {question, answer}
  autoGenerated   Boolean  @default(false)
  lastRegenerated DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([entityType, entityId])
  @@unique([entityType, slug])
}
```

#### Servicios

**`src/services/seo.service.ts`** - L√≥gica principal:
- `generateSEO()`: Genera SEO usando templates y OpenAI
- `applyTemplate()`: Reemplaza variables en templates
- `generateFAQ()`: Llama a GPT-4o-mini para crear FAQ
- `saveSEO()`, `updateSEO()`, `deleteSEO()`: CRUD de SEO
- `upsertConfig()`: Configuraci√≥n de templates y prompts

**Triggers autom√°ticos** en servicios de entidades:
- `event.service.ts`: `triggerAutoSEO()` al crear evento publicado
- `competition.service.ts`: `triggerAutoSEO()` al crear competici√≥n
- `posts.service.ts`: `triggerAutoSEO()` al crear/publicar post

#### API Endpoints

**P√∫blicos:**
- `GET /api/v2/seo/:entityType/:entityId` - Obtener SEO de una entidad

**Admin (requiere autenticaci√≥n):**
- `GET /api/v2/seo/config` - Listar configuraciones
- `POST /api/v2/seo/config` - Crear/actualizar configuraci√≥n
- `GET /api/v2/seo/config/:entityType` - Obtener configuraci√≥n espec√≠fica
- `GET /api/v2/seo/list/:entityType` - Listar SEO por tipo
- `POST /api/v2/seo/generate` - Generar SEO
- `POST /api/v2/seo/regenerate` - Regenerar SEO (elimina y crea nuevo)
- `PUT /api/v2/seo/:id` - Actualizar SEO manualmente
- `DELETE /api/v2/seo/:id` - Eliminar SEO

### Frontend

#### Componentes

**`components/SEOFaqSchema.tsx`** - Componente reutilizable:
```typescript
interface SEOFaqSchemaProps {
  faq: Array<{ question: string; answer: string }>;
  visible?: boolean; // Si true, muestra FAQ visible adem√°s del schema
}
```

Genera:
- JSON-LD con Schema.org FAQPage markup
- (Opcional) FAQ visible con `<details>` HTML nativo

#### P√°ginas P√∫blicas con SEO

**Eventos** - `app/[locale]/events/[eventSlug]/page.tsx`:
- Server Component
- SEO en `generateMetadata()` para meta tags
- FAQ visible al final de la p√°gina

**Competiciones** - `app/[locale]/events/[eventSlug]/[competitionSlug]/page.tsx`:
- Client Component
- SEO fetch en useEffect
- FAQ visible al final de la p√°gina

**Posts** - `app/[locale]/magazine/[category]/[slug]/page.tsx`:
- Client Component
- SEO fetch en useEffect
- FAQ visible al final del art√≠culo

#### Interfaz de Administraci√≥n

**Configuraci√≥n** - `app/[locale]/admin/seo/config/page.tsx`:
- Tabs por tipo de entidad
- Editor de templates (meta title, meta description)
- Editor de prompt para FAQ
- Switches para auto-generaci√≥n
- Muestra variables disponibles

**Gesti√≥n** - `app/[locale]/admin/seo/page.tsx`:
- Selector de tipo de entidad
- Tabla con listado de SEO
- Edici√≥n manual de metadatos
- Editor de FAQ (agregar/eliminar preguntas)
- Regeneraci√≥n individual
- Eliminaci√≥n

#### API Service

**`lib/api/seo.service.ts`** - Cliente TypeScript para API:
```typescript
class SEOService {
  async getSEO(entityType: string, entityId: string): Promise<SEO | null>
  async listSEO(entityType: string, page?: number, limit?: number)
  async generateSEO(input: GenerateSEOInput): Promise<SEO>
  async regenerateSEO(input: GenerateSEOInput): Promise<SEO>
  async updateSEO(id: string, data): Promise<SEO>
  async deleteSEO(id: string): Promise<void>
  async listConfigs(): Promise<SEOConfig[]>
  async getConfig(entityType: string): Promise<SEOConfig>
  async upsertConfig(data: UpsertConfigInput): Promise<SEOConfig>
}
```

---

## Flujo de Generaci√≥n Autom√°tica

1. **Usuario crea entidad** (evento, competici√≥n, post)
2. **Servicio guarda la entidad** en base de datos
3. **Trigger autom√°tico** verifica:
   - ¬øEst√° publicado? (eventos/posts)
   - ¬øConfiguraci√≥n existe?
   - ¬ø`autoGenerate` y `generateOnCreate` activados?
4. **Si todo OK**, ejecuta en segundo plano:
   ```typescript
   setImmediate(() => {
     SEOService.generateAndSave({ ... });
   });
   ```
5. **SEOService procesa**:
   - Obtiene configuraci√≥n
   - Aplica templates reemplazando variables
   - Llama a OpenAI para generar FAQ
   - Guarda en base de datos
6. **FAQ disponible** para motores de b√∫squeda y LLMs

---

## Variables Disponibles por Tipo

### Eventos (`event`)
- `{name}` - Nombre del evento
- `{description}` - Descripci√≥n
- `{city}` - Ciudad
- `{country}` - Pa√≠s
- `{location}` - "Ciudad, Pa√≠s"
- `{year}` - A√±o actual
- `{date}` - Fecha del evento
- `{url}` - URL completa

### Competiciones (`competition`)
- `{name}` - Nombre de la competici√≥n
- `{description}` - Descripci√≥n
- `{event}` - Nombre del evento padre
- `{location}` - Ubicaci√≥n del evento
- `{city}`, `{country}` - Del evento
- `{distance}` - Distancia en km
- `{elevation}` - Desnivel en m+
- `{type}` - Tipo de competici√≥n
- `{url}` - URL completa

### Posts (`post`)
- `{title}` - T√≠tulo del art√≠culo
- `{excerpt}` - Extracto
- `{content}` - Contenido (primeros 500 caracteres)
- `{category}` - Categor√≠a
- `{author}` - Autor
- `{url}` - URL completa

---

## Configuraci√≥n Inicial (Seed)

El archivo `src/seeds/seo-config.seed.ts` crea configuraciones por defecto para todos los tipos de entidad.

**Ejecutar seed:**
```bash
npx ts-node src/seeds/seo-config.seed.ts
```

O desde el seed principal:
```typescript
import { seedSEOConfig } from './seeds/seo-config.seed';
await seedSEOConfig();
```

---

## Ejemplos de Uso

### 1. Configurar Template de Evento

**Admin UI:**
1. Ir a `/admin/seo/config`
2. Seleccionar tab "Eventos"
3. Editar meta title:
   ```
   {name} - Trail Running en {location} | WWTrail
   ```
4. Editar meta description:
   ```
   {description} üèÉ Descubre {name} en {location}. Informaci√≥n completa, ediciones, inscripciones y m√°s.
   ```
5. Personalizar prompt para FAQ
6. Guardar

**API:**
```typescript
await seoService.upsertConfig({
  entityType: 'event',
  metaTitleTemplate: '{name} - Trail Running en {location} | WWTrail',
  metaDescriptionTemplate: '...',
  qaPrompt: '...',
  autoGenerate: true,
  generateOnCreate: true,
});
```

### 2. Generar SEO Manualmente

**Admin UI:**
1. Ir a `/admin/seo`
2. Seleccionar tipo de entidad
3. Click en bot√≥n "Generar SEO"

**API:**
```typescript
await seoService.generateSEO({
  entityType: 'event',
  entityId: 'event-uuid',
  data: {
    name: 'UTMB Mont Blanc',
    location: 'Chamonix, France',
    description: '...',
    // ... m√°s variables
  }
});
```

### 3. Editar FAQ Manualmente

**Admin UI:**
1. Ir a `/admin/seo`
2. Buscar la entidad
3. Click en "Editar"
4. Modificar preguntas/respuestas
5. Agregar o eliminar items
6. Guardar

**API:**
```typescript
await seoService.updateSEO(seoId, {
  llmFaq: [
    { question: '¬øQu√© es el UTMB?', answer: '...' },
    { question: '¬øCu√°ndo se celebra?', answer: '...' },
    // ... 5 items total
  ]
});
```

### 4. Integrar en Nueva P√°gina

**Server Component:**
```typescript
import { seoService } from '@/lib/api/seo.service';
import { SEOFaqSchema } from '@/components/SEOFaqSchema';

export async function generateMetadata({ params }) {
  const entity = await getEntity(params.id);
  const seo = await seoService.getSEO('entity-type', entity.id);

  return {
    title: seo?.metaTitle || entity.defaultTitle,
    description: seo?.metaDescription || entity.defaultDescription,
  };
}

export default async function Page({ params }) {
  const entity = await getEntity(params.id);
  const seo = await seoService.getSEO('entity-type', entity.id);

  return (
    <div>
      {/* Contenido de la p√°gina */}

      {/* FAQ al final */}
      {seo?.llmFaq && seo.llmFaq.length > 0 && (
        <SEOFaqSchema faq={seo.llmFaq} visible={true} />
      )}
    </div>
  );
}
```

**Client Component:**
```typescript
'use client';
import { useState, useEffect } from 'react';
import { seoService } from '@/lib/api/seo.service';
import { SEOFaqSchema } from '@/components/SEOFaqSchema';

export default function Page() {
  const [entity, setEntity] = useState(null);
  const [seo, setSeo] = useState(null);

  useEffect(() => {
    const fetchSEO = async () => {
      if (entity?.id) {
        const seoData = await seoService.getSEO('entity-type', entity.id);
        setSeo(seoData);
      }
    };
    fetchSEO();
  }, [entity?.id]);

  return (
    <div>
      {/* Contenido */}

      {seo?.llmFaq && seo.llmFaq.length > 0 && (
        <SEOFaqSchema faq={seo.llmFaq} visible={true} />
      )}
    </div>
  );
}
```

---

## Migraciones Pendientes

Despu√©s de implementar el sistema, ejecutar:

```bash
# 1. Generar cliente Prisma
npx prisma generate

# 2. Crear y aplicar migraci√≥n
npx prisma migrate dev --name add-seo-system

# 3. Ejecutar seed de configuraci√≥n
npx ts-node src/seeds/seo-config.seed.ts
```

---

## Optimizaci√≥n para LLMs

El sistema est√° dise√±ado espec√≠ficamente para que LLMs como ChatGPT, Claude y Perplexity puedan:

1. **Extraer informaci√≥n estructurada** gracias al Schema.org markup
2. **Responder preguntas frecuentes** con las FAQ generadas
3. **Entender el contexto** mediante prompts optimizados
4. **Proporcionar informaci√≥n precisa** a usuarios que buscan datos sobre eventos/competiciones

### Ejemplo de Prompt Optimizado (Eventos)

```
Estoy generando contenido SEO para el evento de trail running "{name}".

URL: {url}
Ubicaci√≥n: {location}
Descripci√≥n: {description}

Genera en formato JSON exactamente 5 preguntas y respuestas optimizadas para que LLMs
(ChatGPT, Claude, Perplexity) puedan extraer informaci√≥n f√°cilmente de nuestro sitio.

Las preguntas deben cubrir:
1. Qu√© es el evento y cu√°ndo se celebra
2. D√≥nde se celebra y c√≥mo llegar
3. Distancias disponibles y caracter√≠sticas t√©cnicas
4. C√≥mo inscribirse y fechas de inscripci√≥n
5. Informaci√≥n pr√°ctica (alojamiento, qu√© llevar, etc.)

Responde SOLO con un JSON v√°lido en este formato exacto:
{
  "faq": [
    {"question": "...", "answer": "..."},
    {"question": "...", "answer": "..."},
    {"question": "...", "answer": "..."},
    {"question": "...", "answer": "..."},
    {"question": "...", "answer": "..."}
  ]
}
```

---

## Archivos Modificados/Creados

### Backend
- ‚úÖ `prisma/schema.prisma` - Modelos SEOConfig y SEO
- ‚úÖ `src/services/seo.service.ts` - L√≥gica principal (428 l√≠neas)
- ‚úÖ `src/controllers/seo.controller.ts` - Controladores de API
- ‚úÖ `src/routes/seo.routes.ts` - Rutas de API
- ‚úÖ `src/services/event.service.ts` - Trigger autom√°tico
- ‚úÖ `src/services/competition.service.ts` - Trigger autom√°tico
- ‚úÖ `src/services/posts.service.ts` - Triggers autom√°ticos
- ‚úÖ `src/seeds/seo-config.seed.ts` - Configuraci√≥n inicial (229 l√≠neas)
- ‚úÖ `src/index.ts` - Registro de rutas SEO

### Frontend
- ‚úÖ `lib/api/seo.service.ts` - Cliente API TypeScript
- ‚úÖ `components/SEOFaqSchema.tsx` - Componente reutilizable
- ‚úÖ `app/[locale]/admin/seo/config/page.tsx` - Configuraci√≥n admin (346 l√≠neas)
- ‚úÖ `app/[locale]/admin/seo/page.tsx` - Gesti√≥n admin (416 l√≠neas)
- ‚úÖ `app/[locale]/events/[eventSlug]/page.tsx` - Integraci√≥n eventos
- ‚úÖ `app/[locale]/events/[eventSlug]/[competitionSlug]/page.tsx` - Integraci√≥n competiciones
- ‚úÖ `app/[locale]/magazine/[category]/[slug]/page.tsx` - Integraci√≥n posts

---

## Commits Realizados

1. `d1f30a4` - feat(seo): Implement complete SEO management system with AI-powered FAQ generation
2. `238bf20` - feat(seo): Add automatic SEO generation triggers for Competition and Post
3. `86d926a` - feat(seo): Add seed data with default SEO configurations for all entity types
4. `2d5f5a9` - feat(seo): Implement complete admin interface for SEO management
5. `ce4226f` - feat(seo): Integrate SEO and FAQ Schema.org markup in public pages

---

## Pr√≥ximos Pasos (Opcional)

1. **Monitoreo**: Crear dashboard para ver estad√≠sticas de SEO generado
2. **Analytics**: Integrar Google Search Console para medir impacto
3. **A/B Testing**: Probar diferentes prompts y templates
4. **Expansi√≥n**: Agregar m√°s tipos de entidad (organizadores, series especiales)
5. **Validaci√≥n**: Implementar validaci√≥n de Schema.org con herramientas de Google
6. **Cache**: Cachear FAQ en CDN para mejorar rendimiento
7. **Versioning**: Mantener historial de cambios en FAQ generados

---

## Soporte

Para m√°s informaci√≥n sobre el sistema SEO:
- Ver c√≥digo en `src/services/seo.service.ts`
- Revisar configuraciones en `/admin/seo/config`
- Consultar FAQ generadas en las p√°ginas p√∫blicas

Sistema desarrollado con ‚ù§Ô∏è para WWTrail
